<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Shuluq School System</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js for 3D Visuals -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- SheetJS for Excel Export/Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <!-- Icons (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }

        /* Night Mode Variables */
        .dark-mode {
            background-color: #111827 !important;
            color: #e5e7eb !important;
        }
        .dark-mode .glass-panel, 
        .dark-mode .bg-white {
            background-color: #1f2937 !important;
            border-color: #374151 !important;
            color: #e5e7eb !important;
        }
        .dark-mode input, 
        .dark-mode select {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: white !important;
        }
        .dark-mode .text-gray-500, 
        .dark-mode .text-gray-600, 
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-800 {
            color: #d1d5db !important;
        }
        .dark-mode .bg-gray-50 {
            background-color: #111827 !important;
        }
        .dark-mode .border-gray-100,
        .dark-mode .divide-gray-100 > * + * {
            border-color: #374151 !important;
        }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; color: black !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">

        const { useState, useEffect, useRef, useMemo } = React;
        
        // --- Gemini API Configuration ---
        const apiKey = ""; 

        const callGeminiAPI = async (prompt) => {
            try {
                // Force Somali Language
                const somaliPrompt = `Jawaabta oo dhan ku qor Af-Soomaali (Write the response entirely in Somali language): ${prompt}`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: somaliPrompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("AI Error:", error);
                return "Khalad ayaa dhacay. Fadlan hubi Internetkaaga ama API key-ga.";
            }
        };

        // --- Icons Components ---
        const Icon = ({ name, className, onClick }) => <i onClick={onClick} className={`ph ph-${name} ${className}`}></i>;

        // --- AI Result Modal ---
        const AIModal = ({ title, content, onClose, isLoading }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg m-4 overflow-hidden flex flex-col max-h-[80vh] animate-slide-up relative">
                    <div className="bg-gradient-to-r from-indigo-600 to-blue-600 p-4 flex justify-between items-center text-white">
                        <div className="flex items-center gap-2">
                            <Icon name="sparkle" className="text-yellow-300 text-xl animate-pulse" />
                            <h3 className="font-bold text-lg">{title}</h3>
                        </div>
                        <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full transition"><Icon name="x" /></button>
                    </div>
                    <div className="p-6 overflow-y-auto">
                        {isLoading ? (
                            <div className="flex flex-col items-center justify-center py-8 space-y-4">
                                <div className="loader"></div>
                                <p className="text-indigo-600 animate-pulse font-medium">AI-gu wuu fikirayaa...</p>
                            </div>
                        ) : (
                            <div className="prose prose-indigo">
                                <div className="whitespace-pre-wrap leading-relaxed border-l-4 border-indigo-500 pl-4 bg-opacity-10 bg-indigo-500 p-4 rounded-r-lg">
                                    {content}
                                </div>
                            </div>
                        )}
                    </div>
                    {!isLoading && (
                        <div className="p-4 border-t flex justify-end gap-2 bg-opacity-5 bg-black">
                            <button onClick={() => { navigator.clipboard.writeText(content); }} className="px-4 py-2 text-sm font-medium border rounded-lg hover:bg-opacity-10 hover:bg-black transition flex items-center gap-2">
                                <Icon name="copy" /> Copy
                            </button>
                            <button onClick={onClose} className="px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition">
                                Xir
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );

        // --- Student Detail Modal ---
        const StudentDetailModal = ({ student, classes, onClose }) => {
            if (!student) return null;
            const className = classes.find(c => c.id === student.classId)?.name || 'Unknown Class';

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white hover:bg-white/20 p-1 rounded-full z-10"><Icon name="x" className="text-xl" /></button>
                        
                        {/* Header */}
                        <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-8 text-center text-white relative overflow-hidden">
                             <div className="absolute inset-0 opacity-20">
                                <div className="absolute top-0 left-0 w-full h-full" style={{backgroundImage: 'radial-gradient(circle, white 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                            </div>
                            <div className="w-20 h-20 bg-white rounded-full mx-auto flex items-center justify-center text-3xl font-bold text-indigo-600 shadow-lg mb-3 relative z-10">
                                {student.name.charAt(0)}
                            </div>
                            <h2 className="text-2xl font-bold relative z-10">{student.name}</h2>
                            <p className="opacity-90 font-mono bg-white/20 inline-block px-2 py-1 rounded mt-2 text-sm relative z-10">{student.generatedId}</p>
                        </div>

                        {/* Content */}
                        <div className="p-6 space-y-6">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-opacity-5 bg-black p-3 rounded-xl border">
                                    <p className="text-xs font-bold opacity-60 uppercase">Class</p>
                                    <p className="font-medium">{className}</p>
                                </div>
                                <div className="bg-opacity-5 bg-black p-3 rounded-xl border">
                                    <p className="text-xs font-bold opacity-60 uppercase">Time</p>
                                    <p className="font-medium">{student.classTime || 'N/A'}</p>
                                </div>
                            </div>

                            {/* Contact Info with Clickable Links */}
                            <div className="space-y-4">
                                <div>
                                    <p className="text-xs font-bold opacity-60 uppercase mb-1">Student Number</p>
                                    <a href={`tel:${student.number}`} className="flex items-center gap-3 p-3 bg-indigo-50 text-indigo-700 rounded-xl border border-indigo-100 hover:bg-indigo-100 transition cursor-pointer group dark:bg-indigo-900 dark:text-indigo-200 dark:border-indigo-800">
                                        <Icon name="phone" className="text-xl" />
                                        <span className="font-bold group-hover:underline">{student.number || 'No Number'}</span>
                                    </a>
                                </div>

                                <div>
                                    <p className="text-xs font-bold opacity-60 uppercase mb-1">Guardian Info</p>
                                    <div className="border rounded-xl p-4">
                                        <p className="font-semibold mb-2 flex items-center gap-2">
                                            <Icon name="users" /> {student.guardianName || 'No Guardian Name'}
                                        </p>
                                        <a href={`tel:${student.guardianNumber}`} className="flex items-center gap-3 text-indigo-600 hover:text-indigo-800 font-medium transition cursor-pointer hover:underline dark:text-indigo-400">
                                            <Icon name="phone-call" />
                                            {student.guardianNumber || 'No Contact'}
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="pt-2 border-t flex justify-between text-xs opacity-60">
                                <span>Teacher: {student.teacher || 'Unassigned'}</span>
                                <span>Joined: {student.dateStarted || '-'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Toast Notification Component ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';

            return (
                <div className={`fixed top-4 right-4 ${bgClass} text-white px-6 py-3 rounded-lg shadow-xl z-50 flex items-center gap-3 animate-slide-up`}>
                    <Icon name={type === 'success' ? 'check-circle' : 'warning'} className="text-xl" />
                    <span className="font-medium">{message}</span>
                </div>
            );
        };

        // --- Enhanced 3D Background (Classic & Alive) ---
        const ThreeBackground = ({ darkMode }) => {
            const mountRef = useRef(null);
            useEffect(() => {
                const scene = new THREE.Scene();
                // Background Color based on mode
                scene.background = new THREE.Color(darkMode ? 0x111827 : 0xf3f4f6);
                
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                if(mountRef.current) {
                    mountRef.current.innerHTML = '';
                    mountRef.current.appendChild(renderer.domElement);
                }

                // Classic Shapes
                const shapes = [];
                const geometry1 = new THREE.IcosahedronGeometry(1, 0);
                const geometry2 = new THREE.TorusGeometry(0.7, 0.2, 16, 100);
                
                const materialColor = darkMode ? 0x6366f1 : 0x3b82f6; // Indigo vs Blue
                const material = new THREE.MeshStandardMaterial({ color: materialColor, wireframe: true, transparent: true, opacity: 0.3 });

                for(let i=0; i<12; i++) {
                    const mesh = new THREE.Mesh(i % 2 === 0 ? geometry1 : geometry2, material);
                    mesh.position.set((Math.random()-0.5)*25, (Math.random()-0.5)*25, (Math.random()-0.5)*15);
                    mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, 0);
                    scene.add(mesh);
                    shapes.push({ mesh, speedX: (Math.random()-0.5)*0.005, speedY: (Math.random()-0.5)*0.005, rot: Math.random()*0.01 });
                }

                // Particles for "Alive" feel
                const particlesGeom = new THREE.BufferGeometry();
                const particlesCount = 200;
                const posArray = new Float32Array(particlesCount * 3);
                for(let i=0; i<particlesCount*3; i++) posArray[i] = (Math.random()-0.5) * 30;
                particlesGeom.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                const particlesMat = new THREE.PointsMaterial({ size: 0.05, color: materialColor });
                const particlesMesh = new THREE.Points(particlesGeom, particlesMat);
                scene.add(particlesMesh);

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const pLight = new THREE.PointLight(0xffffff, 0.8);
                pLight.position.set(5,5,5);
                scene.add(pLight);

                camera.position.z = 6;

                let animationId;
                const animate = () => {
                    animationId = requestAnimationFrame(animate);
                    shapes.forEach(s => {
                        s.mesh.rotation.x += s.rot;
                        s.mesh.rotation.y += s.rot;
                        s.mesh.position.x += s.speedX;
                        s.mesh.position.y += s.speedY;
                        // Wrap around
                        if(s.mesh.position.y > 10) s.mesh.position.y = -10;
                        if(s.mesh.position.y < -10) s.mesh.position.y = 10;
                    });
                    particlesMesh.rotation.y += 0.001;
                    renderer.render(scene, camera);
                };
                animate();

                const handleResize = () => {
                    if (!camera || !renderer) return;
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationId);
                };
            }, [darkMode]); // Re-run when darkMode changes
            return <div ref={mountRef} className="fixed top-0 left-0 w-full h-full -z-10 pointer-events-none" />;
        };

        // --- Hooks ---
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) { console.error(error); }
            };
            return [storedValue, setValue];
        };

        // --- Helper Functions ---
        const generateStudentId = (currentStudents) => {
            const date = new Date();
            const yearLastTwo = date.getFullYear().toString().slice(-2); 
            let maxSeq = 0;
            currentStudents.forEach(s => {
                if(s.generatedId && s.generatedId.startsWith(yearLastTwo)) {
                    const seqPart = parseInt(s.generatedId.substring(2));
                    if(!isNaN(seqPart) && seqPart > maxSeq) maxSeq = seqPart;
                }
            });
            return `${yearLastTwo}${(maxSeq + 1).toString().padStart(3, '0')}`;
        };

        const classTimes = [];
        for(let i=6; i<=18; i++) {
            const hour = i < 10 ? `0${i}` : i;
            classTimes.push(`${hour}:00`);
        }

        // --- Main App ---
        const App = () => {
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [toast, setToast] = useState(null);
            const [darkMode, setDarkMode] = useState(false);
            
            const [aiModal, setAiModal] = useState({ isOpen: false, title: '', content: '', loading: false });

            // Data
            const [users, setUsers] = useLocalStorage('school_users', [
                { id: 1, username: 'admin', password: '2222', role: 'admin', name: 'Administrator' },
                { id: 2, username: 'teach', password: '1111', role: 'teacher', name: 'General Teacher' }
            ]);
            
            const [teachersList, setTeachersList] = useLocalStorage('school_teachers_list', ['Zakariye', 'C/qaadir', 'Khaalid', 'Shabiye']);
            
            // Updated Classes List as per request
            const [classes, setClasses] = useLocalStorage('school_classes_v2', [
                { id: 1, name: 'Software' }, { id: 2, name: 'Hardware' }, { id: 3, name: 'Graphics Design' },
                { id: 4, name: 'B1 Coding' }, { id: 5, name: 'B2 Coding' }, { id: 6, name: 'App Design' },
                { id: 7, name: 'App Dev. Software' }, { id: 8, name: 'Web Design' }, { id: 9, name: 'Web dev' },
                { id: 10, name: 'Canva' }, { id: 11, name: 'Figma' }, { id: 12, name: 'Notion' }, 
                { id: 13, name: 'Google Work Apps' }
            ]);

            const [students, setStudents] = useLocalStorage('school_students', [
                { id: 1, generatedId: '25001', name: 'Ahmed Yasin', classId: 1, number: '0615000001', guardianName: 'Yasin Ali', guardianNumber: '0615000002', classTime: '08:00', teacher: 'Zakariye', courseType: 'Normal', dateStarted: '2025-01' },
                { id: 2, generatedId: '25002', name: 'Sarah Mohamed', classId: 4, number: '0615000003', guardianName: 'Mohamed Nur', guardianNumber: '0615000004', classTime: '10:00', teacher: 'Khaalid', courseType: 'Course', dateStarted: '2025-02' }
            ]);

            const [attendance, setAttendance] = useLocalStorage('school_attendance', []);
            const [exams, setExams] = useLocalStorage('school_exams', {}); 

            const [currentView, setCurrentView] = useState('dashboard');

            // Night Mode Toggle Effect
            useEffect(() => {
                if(darkMode) document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
            }, [darkMode]);

            useEffect(() => {
                const timer = setTimeout(() => setLoading(false), 2000);
                return () => clearTimeout(timer);
            }, []);

            const showToast = (msg, type='success') => setToast({ message: msg, type });

            const handleLogin = (u, p) => {
                const found = users.find(usr => usr.username === u && usr.password === p);
                if (found) setUser(found);
                else showToast('Invalid credentials', 'error');
            };

            // AI Helper (Forces Somali in callGeminiAPI)
            const triggerAI = async (title, prompt) => {
                setAiModal({ isOpen: true, title, content: '', loading: true });
                const result = await callGeminiAPI(prompt);
                setAiModal({ isOpen: true, title, content: result, loading: false });
            };

            const handleLogout = () => {
                setUser(null);
                setCurrentView('dashboard');
            };

            const backupData = () => {
                const data = { users, teachersList, classes, students, attendance, exams };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AlShuluq_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                showToast('Backup downloaded successfully');
            };

            // Import Logic
            const handleImport = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, {type:'binary'});
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws);
                        
                        // Naive merge - assumes Excel headers match our student keys roughly
                        // Ideally would validate, but for now we just map basic fields or append
                        const newStudents = data.map((row, idx) => ({
                            id: Date.now() + idx,
                            generatedId: generateStudentId([...students, ...data.slice(0,idx).map(d=>({generatedId: '25000'}))]), // Temp Logic
                            name: row.Name || row.name || 'Unknown Import',
                            classId: 1, // Default to first class
                            number: row.Number || '',
                            courseType: 'Normal',
                            ...row
                        }));
                        setStudents([...students, ...newStudents]);
                        showToast(`Imported ${newStudents.length} students!`);
                    } catch(err) {
                        console.error(err);
                        showToast('Error parsing Excel file', 'error');
                    }
                };
                reader.readAsBinaryString(file);
            };

            if (loading) return <SplashScreen />;
            if (!user) return <LoginPage onLogin={handleLogin} showToast={showToast} toast={toast} onCloseToast={() => setToast(null)} />;

            return (
                <div className="flex h-screen overflow-hidden">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    {aiModal.isOpen && <AIModal title={aiModal.title} content={aiModal.content} isLoading={aiModal.loading} onClose={() => setAiModal({ ...aiModal, isOpen: false })} />}
                    
                    <ThreeBackground darkMode={darkMode} />

                    <Sidebar user={user} onViewChange={setCurrentView} currentView={currentView} onLogout={handleLogout} />
                    
                    <main className="flex-1 overflow-y-auto p-4 md:p-8 relative z-10">
                        <div className="flex justify-between items-center mb-6">
                            <Header user={user} title={currentView.replace(/([A-Z])/g, ' $1').trim()} />
                            {/* Night Mode Toggle */}
                            <button 
                                onClick={() => setDarkMode(!darkMode)} 
                                className="p-3 rounded-full bg-white dark:bg-gray-800 shadow-lg hover:scale-110 transition border dark:border-gray-700"
                                title="Toggle Night Mode"
                            >
                                <Icon name={darkMode ? 'sun' : 'moon'} className={`text-xl ${darkMode ? 'text-yellow-400' : 'text-indigo-600'}`} />
                            </button>
                        </div>
                        
                        <div className="mt-6 animate-slide-up">
                            {currentView === 'dashboard' && <Dashboard students={students} attendance={attendance} classes={classes} onBackup={backupData} onViewChange={setCurrentView} />}
                            {currentView === 'attendance' && <AttendanceView user={user} classes={classes} students={students} attendance={attendance} setAttendance={setAttendance} showToast={showToast} onTriggerAI={triggerAI} />}
                            {currentView === 'exams' && <ExamManager user={user} classes={classes} students={students} exams={exams} setExams={setExams} showToast={showToast} onTriggerAI={triggerAI} />}
                            {currentView === 'reports' && <ReportView classes={classes} students={students} attendance={attendance} />}
                            {currentView === 'settings' && <SettingsView onImport={handleImport} />}
                            
                            {/* Admin Only Views */}
                            {user.role === 'admin' && currentView === 'students' && (
                                <StudentManager 
                                    classes={classes} students={students} setStudents={setStudents} 
                                    teachersList={teachersList} showToast={showToast} attendance={attendance} exams={exams} onTriggerAI={triggerAI}
                                />
                            )}
                            {user.role === 'admin' && currentView === 'classes' && <ClassManager classes={classes} setClasses={setClasses} showToast={showToast} />}
                            {user.role === 'admin' && currentView === 'users' && <UserManager users={users} setUsers={setUsers} teachersList={teachersList} setTeachersList={setTeachersList} showToast={showToast} />}
                        </div>
                    </main>
                </div>
            );
        };

        // --- Sub-Components ---

        const SplashScreen = () => (
            <div className="fixed inset-0 bg-indigo-900 flex flex-col items-center justify-center z-50">
                <div className="loader mb-4"></div>
                <h1 className="text-white text-2xl font-bold tracking-widest">AL SHULUQ SCHOOL</h1>
                <p className="text-indigo-300 text-sm mt-2">Loading Resources...</p>
            </div>
        );

        const LoginPage = ({ onLogin, toast, onCloseToast }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            return (
                <div className="relative w-full h-screen flex items-center justify-center overflow-hidden bg-gray-900">
                    <ThreeBackground darkMode={true} /> 
                    {toast && <Toast message={toast.message} type={toast.type} onClose={onCloseToast} />}
                    <div className="glass-panel p-8 md:p-10 rounded-2xl shadow-2xl w-full max-w-sm z-10 mx-4">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <Icon name="graduation-cap" className="text-3xl text-white" />
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800">Al Shuluq Portal</h1>
                            <p className="text-gray-500 text-sm mt-2">Secure Login System</p>
                        </div>
                        <form onSubmit={(e) => { e.preventDefault(); onLogin(u, p); }} className="space-y-4">
                            <input type="text" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50" placeholder="Username" value={u} onChange={e => setU(e.target.value)} />
                            <input type="password" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50" placeholder="Password" value={p} onChange={e => setP(e.target.value)} />
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition transform hover:scale-105">Sign In</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ user, onViewChange, currentView, onLogout }) => {
            const [isOpen, setIsOpen] = useState(false);

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'squares-four' },
                { id: 'attendance', label: 'Attendance', icon: 'check-circle' },
                { id: 'exams', label: 'Exams', icon: 'exam' },
                { id: 'reports', label: 'Reports', icon: 'file-xls' },
            ];

            if (user.role === 'admin') {
                menuItems.push({ id: 'students', label: 'Students', icon: 'users' });
                menuItems.push({ id: 'classes', label: 'Classes', icon: 'chalkboard-teacher' });
                menuItems.push({ id: 'users', label: 'Users & Teachers', icon: 'lock-key' });
            }
            // Add Settings for everyone
             menuItems.push({ id: 'settings', label: 'Settings', icon: 'gear' });

            return (
                <>
                    {/* Mobile Toggle */}
                    <button onClick={() => setIsOpen(!isOpen)} className="md:hidden fixed top-4 left-4 z-50 bg-indigo-600 text-white p-2 rounded shadow">
                        <Icon name={isOpen ? 'x' : 'list'} className="text-xl" />
                    </button>
                    
                    <div className={`fixed inset-y-0 left-0 w-64 bg-white border-r border-gray-200 transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col no-print`}>
                        <div className="p-6 border-b border-gray-100 flex items-center gap-3">
                             <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><Icon name="school" className="text-2xl" /></div>
                            <span className="font-bold text-xl text-gray-800">Al Shuluq</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            {menuItems.map(item => (
                                <button key={item.id} onClick={() => { onViewChange(item.id); setIsOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors ${currentView === item.id ? 'bg-indigo-50 text-indigo-600 border border-indigo-100 dark:bg-gray-700 dark:text-white' : 'text-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'}`}>
                                    <Icon name={item.icon} className="text-lg" /> {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-gray-100">
                            <div className="flex items-center gap-3 mb-4 px-2">
                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold text-xs">
                                    {user.username.charAt(0).toUpperCase()}
                                </div>
                                <div className="flex-1 truncate">
                                    <p className="text-sm font-semibold text-gray-800">{user.username}</p>
                                    <p className="text-xs text-gray-500 capitalize">{user.role}</p>
                                </div>
                            </div>
                            <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition">
                                <Icon name="sign-out" /> Logout
                            </button>
                        </div>
                    </div>
                    {/* Overlay for mobile */}
                    {isOpen && <div onClick={() => setIsOpen(false)} className="fixed inset-0 bg-black/50 z-30 md:hidden"></div>}
                </>
            );
        };

        const Header = ({ user, title }) => (
            <div className="no-print">
                <h2 className="text-2xl font-bold text-gray-800 capitalize">{title}</h2>
                <p className="text-gray-500 text-sm">Welcome back, {user.name}.</p>
            </div>
        );

        const Dashboard = ({ students, attendance, classes, onBackup, onViewChange }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [viewStudent, setViewStudent] = useState(null); 
            
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendance.filter(r => r.date === today);
            
            let absentStudentIds = [];
            todayRecords.forEach(record => {
                Object.entries(record.records).forEach(([sid, status]) => {
                    if(status === 'A') absentStudentIds.push(parseInt(sid));
                });
            });

            const absentStudents = students.filter(s => absentStudentIds.includes(s.id));
            
            const filteredStudents = students.filter(s => 
                s.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                s.id.toString().includes(searchQuery) ||
                (s.number && s.number.includes(searchQuery))
            );

            return (
                <div className="space-y-6">
                    <StudentDetailModal student={viewStudent} classes={classes} onClose={() => setViewStudent(null)} />

                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                         <div className="relative flex-1 max-w-lg">
                            <Icon name="magnifying-glass" className="absolute left-3 top-3 text-gray-400" />
                            <input 
                                type="text" 
                                placeholder="Search students..." 
                                className="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>
                        <button onClick={onBackup} className="bg-gray-800 text-white px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-gray-900 shadow-lg transition">
                            <Icon name="download-simple" /> Backup Data
                        </button>
                    </div>

                    {searchQuery && (
                        <div className="bg-white p-4 rounded-xl shadow-lg border border-indigo-100 relative z-10">
                            <h3 className="font-bold text-gray-700 mb-2">Search Results</h3>
                            {filteredStudents.length === 0 ? <p className="text-gray-500 text-sm">No students found.</p> : (
                                <ul className="space-y-2">
                                    {filteredStudents.map(s => (
                                        <li key={s.id} onClick={() => setViewStudent(s)} className="p-3 bg-gray-50 hover:bg-indigo-50 cursor-pointer rounded flex justify-between text-sm items-center transition">
                                            <div>
                                                <span className="font-bold text-indigo-600 mr-2">{s.generatedId}</span>
                                                <span>{s.name}</span>
                                            </div>
                                            <span className="text-gray-500 text-xs">{classes.find(c=>c.id===s.classId)?.name}</span>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-blue-100 text-blue-600 rounded-xl"><Icon name="student" className="text-3xl" /></div>
                            <div><p className="text-gray-500 text-xs font-bold uppercase">Total Students</p><p className="text-2xl font-bold">{students.length}</p></div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-red-100 text-red-600 rounded-xl"><Icon name="x-circle" className="text-3xl" /></div>
                            <div><p className="text-gray-500 text-xs font-bold uppercase">Absent Today</p><p className="text-2xl font-bold">{absentStudents.length}</p></div>
                        </div>
                         <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                            <div className="p-3 bg-purple-100 text-purple-600 rounded-xl"><Icon name="chalkboard" className="text-3xl" /></div>
                            <div><p className="text-gray-500 text-xs font-bold uppercase">Classes</p><p className="text-2xl font-bold">{classes.length}</p></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <h3 className="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
                                <Icon name="warning-circle" className="text-red-500" /> Absent Students Today
                            </h3>
                            {absentStudents.length > 0 ? (
                                <div className="space-y-3 max-h-64 overflow-y-auto pr-2">
                                    {absentStudents.map(s => (
                                        <div key={s.id} className="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-100">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-red-600 font-bold text-xs shadow-sm">{s.name[0]}</div>
                                                <div>
                                                    <p className="font-medium text-sm text-gray-800">{s.name}</p>
                                                    <p className="text-xs text-red-500">ID: {s.generatedId}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => setViewStudent(s)} className="text-xs bg-white px-3 py-1 rounded border text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition">View</button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-10 text-gray-400 bg-gray-50 rounded-xl border border-dashed">
                                    <Icon name="check-circle" className="text-4xl text-green-400 mb-2 mx-auto" />
                                    <p>All present! No absences recorded today.</p>
                                </div>
                            )}
                        </div>

                        <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-8 text-white relative overflow-hidden shadow-lg">
                             <div className="relative z-10">
                                <h3 className="text-2xl font-bold mb-2">Exam Season?</h3>
                                <p className="opacity-90 mb-6 text-sm">Manage exam scores for Windows, Word, Excel and more efficiently.</p>
                                <button onClick={() => onViewChange('exams')} className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold text-sm shadow-md hover:bg-gray-100 transition">
                                    Go to Exams
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ onImport }) => {
            return (
                <div className="max-w-3xl mx-auto space-y-8">
                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-4 mb-6 pb-4 border-b">
                            <div className="p-3 bg-indigo-100 text-indigo-600 rounded-xl"><Icon name="database" className="text-2xl" /></div>
                            <div>
                                <h3 className="text-xl font-bold">Data Import</h3>
                                <p className="text-gray-500 text-sm">Import student data from your old Excel system.</p>
                            </div>
                        </div>
                        <div className="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl p-10 bg-gray-50 hover:bg-gray-100 transition cursor-pointer relative">
                            <Icon name="file-xls" className="text-5xl text-green-600 mb-2" />
                            <p className="font-medium text-gray-700">Click to upload Excel File</p>
                            <input type="file" accept=".xlsx, .xls" onChange={onImport} className="absolute inset-0 opacity-0 cursor-pointer" />
                        </div>
                    </div>

                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-4 mb-6 pb-4 border-b">
                            <div className="p-3 bg-purple-100 text-purple-600 rounded-xl"><Icon name="code" className="text-2xl" /></div>
                            <div>
                                <h3 className="text-xl font-bold">About the Developer</h3>
                                <p className="text-gray-500 text-sm">System Information & Credits</p>
                            </div>
                        </div>
                        <div className="prose prose-indigo">
                            <p>This advanced School Management System was meticulously crafted to streamline educational operations.</p>
                            <p>Developed by a dedicated engineer committed to excellence in EdTech solutions.</p>
                            <div className="mt-6 p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                                <h4 className="font-bold text-indigo-900 mb-2">Developer Portfolio</h4>
                                <p className="text-sm text-indigo-800 mb-4">Explore more innovative projects and experience the expertise behind this system.</p>
                                <a href="#" target="_blank" className="inline-flex items-center gap-2 bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-indigo-700 transition">
                                    <Icon name="globe" /> Visit Portfolio
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StudentManager = ({ classes, students, setStudents, teachersList, showToast, attendance, exams, onTriggerAI }) => {
            const [form, setForm] = useState({
                name: '', classId: '', password: '', courseType: 'Normal', number: '', 
                guardianName: '', guardianNumber: '', dateStarted: '', teacher: '', classTime: ''
            });

            const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.name || !form.classId) return showToast('Name and Class are required', 'error');

                const newStudent = {
                    id: Date.now(),
                    generatedId: generateStudentId(students),
                    ...form,
                    classId: parseInt(form.classId)
                };

                setStudents([...students, newStudent]);
                setForm({ name: '', classId: '', password: '', courseType: 'Normal', number: '', guardianName: '', guardianNumber: '', dateStarted: '', teacher: '', classTime: '' });
                showToast('Student added successfully');
            };

            const handleDelete = (id) => {
                if(confirm('Delete student?')) {
                    setStudents(students.filter(s => s.id !== id));
                    showToast('Student deleted', 'info');
                }
            };

            const handleGenerateReport = (student) => {
                let absenses = 0;
                attendance.forEach(entry => {
                    if (entry.records[student.id] === 'A') absenses++;
                });

                const studentExams = exams[student.id] || {};
                const scoresStr = Object.entries(studentExams)
                    .filter(([key]) => key !== 'certified')
                    .map(([k, v]) => `${k}: ${v}`).join(', ') || "No exams taken yet";

                const prompt = `You are a school administrator. Write a concise (max 50 words), professional progress summary for a report card for student ${student.name}. 
                Data:
                - Course: ${student.courseType || 'Normal'}
                - Attendance: ${absenses} absences total.
                - Exam Scores: ${scoresStr}.
                highlight strengths if scores are high, or encourage improvement if low.`;

                onTriggerAI(`Progress Report: ${student.name}`, prompt);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                        <h3 className="font-bold text-lg mb-4 text-indigo-900 border-b pb-2">Register New Student</h3>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="md:col-span-3 text-xs font-bold opacity-50 uppercase tracking-wider mt-2">Personal Info</div>
                            <input name="name" value={form.name} onChange={handleChange} placeholder="Full Name" className="border p-2 rounded outline-none focus:border-indigo-500" required />
                            <input name="password" value={form.password} onChange={handleChange} placeholder="Password" type="text" className="border p-2 rounded outline-none focus:border-indigo-500" />
                            <input name="number" value={form.number} onChange={handleChange} placeholder="Phone Number" className="border p-2 rounded outline-none focus:border-indigo-500" />

                            <div className="md:col-span-3 text-xs font-bold opacity-50 uppercase tracking-wider mt-2">Academic Info</div>
                            <select name="classId" value={form.classId} onChange={handleChange} className="border p-2 rounded outline-none focus:border-indigo-500 bg-white" required>
                                <option value="">Select Class</option>
                                {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                            <select name="courseType" value={form.courseType} onChange={handleChange} className="border p-2 rounded outline-none focus:border-indigo-500 bg-white">
                                <option value="Normal">Normal</option>
                                <option value="Course">Course</option>
                            </select>
                            <select name="teacher" value={form.teacher} onChange={handleChange} className="border p-2 rounded outline-none focus:border-indigo-500 bg-white">
                                <option value="">Assign Teacher</option>
                                {teachersList.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                             <select name="classTime" value={form.classTime} onChange={handleChange} className="border p-2 rounded outline-none focus:border-indigo-500 bg-white">
                                <option value="">Class Time</option>
                                {classTimes.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                            <input name="dateStarted" type="month" value={form.dateStarted} onChange={handleChange} className="border p-2 rounded outline-none focus:border-indigo-500" />

                            <div className="md:col-span-3 text-xs font-bold opacity-50 uppercase tracking-wider mt-2">Guardian Info</div>
                            <input name="guardianName" value={form.guardianName} onChange={handleChange} placeholder="Guardian Name" className="border p-2 rounded outline-none focus:border-indigo-500" />
                            <input name="guardianNumber" value={form.guardianNumber} onChange={handleChange} placeholder="Guardian Number" className="border p-2 rounded outline-none focus:border-indigo-500" />

                            <div className="md:col-span-3 mt-4">
                                <button type="submit" className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition w-full md:w-auto">Create Student Profile (ID: {generateStudentId(students)})</button>
                            </div>
                        </form>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden overflow-x-auto">
                        <table className="w-full text-left min-w-[800px]">
                            <thead className="bg-gray-50 border-b text-xs uppercase opacity-60">
                                <tr>
                                    <th className="p-4">ID</th>
                                    <th className="p-4">Name</th>
                                    <th className="p-4">Class</th>
                                    <th className="p-4">Type</th>
                                    <th className="p-4">Time</th>
                                    <th className="p-4">Teacher</th>
                                    <th className="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 text-sm">
                                {students.map(s => (
                                    <tr key={s.id} className="hover:bg-gray-50">
                                        <td className="p-4 font-mono font-bold text-indigo-600">{s.generatedId}</td>
                                        <td className="p-4 font-medium">
                                            {s.name}
                                            <div className="text-xs opacity-50">{s.number}</div>
                                        </td>
                                        <td className="p-4">{classes.find(c => c.id === s.classId)?.name}</td>
                                        <td className="p-4"><span className={`px-2 py-1 rounded text-xs ${s.courseType === 'Normal' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`}>{s.courseType}</span></td>
                                        <td className="p-4">{s.classTime || '-'}</td>
                                        <td className="p-4">{s.teacher || '-'}</td>
                                        <td className="p-4 text-right flex justify-end gap-2">
                                            <button 
                                                onClick={() => handleGenerateReport(s)} 
                                                className="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg hover:bg-indigo-100 flex items-center gap-1 text-xs font-bold border border-indigo-100 dark:bg-indigo-900 dark:text-white dark:border-indigo-700"
                                                title="Generate AI Report"
                                            >
                                                <Icon name="sparkle" /> Report
                                            </button>
                                            <button onClick={() => handleDelete(s.id)} className="text-red-500 bg-red-50 p-2 rounded hover:bg-red-100"><Icon name="trash" /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Reused Components (AttendanceView, ReportView, ClassManager, UserManager, ExamManager)
        const AttendanceView = ({ user, classes, students, attendance, setAttendance, showToast, onTriggerAI }) => {
            const [selectedClass, setSelectedClass] = useState(classes[0]?.id || '');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [tempRecords, setTempRecords] = useState({});

            const filteredStudents = useMemo(() => students.filter(s => s.classId == selectedClass), [students, selectedClass]);

            useEffect(() => {
                const existing = attendance.find(r => r.date === date && r.classId == selectedClass);
                if (existing) setTempRecords(existing.records);
                else {
                    const initial = {};
                    filteredStudents.forEach(s => initial[s.id] = 'P');
                    setTempRecords(initial);
                }
            }, [date, selectedClass, filteredStudents, attendance]);

            const handleSave = () => {
                const otherRecords = attendance.filter(r => !(r.date === date && r.classId === parseInt(selectedClass)));
                setAttendance([...otherRecords, { date, classId: parseInt(selectedClass), records: tempRecords }]);
                showToast('Attendance saved successfully!', 'success');
            };

            const draftGuardianMsg = (student) => {
                const prompt = `Draft a polite, concise (max 40 words) WhatsApp message to the guardian (${student.guardianName || 'Guardian'}) of student ${student.name}. 
                Inform them that the student was marked ABSENT today (${date}). Request a reason for the absence.`;
                onTriggerAI(`Draft Message: ${student.name}`, prompt);
            };

            return (
                 <div className="max-w-4xl mx-auto space-y-6">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-4 items-end">
                        <div><label className="block text-xs font-bold opacity-50 uppercase mb-1">Select Class</label><select value={selectedClass} onChange={e => setSelectedClass(e.target.value)} className="border rounded-lg p-2 min-w-[200px] outline-none">{classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <div><label className="block text-xs font-bold opacity-50 uppercase mb-1">Date</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className="border rounded-lg p-2 outline-none" /></div>
                        <div className="flex-1"></div>
                        <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition flex items-center gap-2"><Icon name="floppy-disk" /> Save</button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        {filteredStudents.map(s => (
                            <div key={s.id} className="p-4 flex items-center justify-between border-b border-gray-50 last:border-0 hover:bg-gray-50">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center font-bold text-gray-500">{s.name[0]}</div>
                                    <div><p className="font-medium">{s.name}</p><p className="text-xs opacity-50">ID: {s.generatedId}</p></div>
                                </div>
                                <div className="flex items-center gap-4">
                                    {tempRecords[s.id] === 'A' && (
                                        <button 
                                            onClick={() => draftGuardianMsg(s)}
                                            className="text-orange-500 hover:bg-orange-50 p-2 rounded-full transition"
                                            title="Draft Guardian Message with AI"
                                        >
                                            <Icon name="chat-text" className="text-xl" /> <span className="text-xs font-bold align-middle">AI Draft</span>
                                        </button>
                                    )}
                                    <button onClick={() => setTempRecords({...tempRecords, [s.id]: tempRecords[s.id] === 'P' ? 'A' : 'P'})} className={`w-20 py-1 rounded-full text-xs font-bold ${tempRecords[s.id] === 'P' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>{tempRecords[s.id] === 'P' ? 'PRESENT' : 'ABSENT'}</button>
                                </div>
                            </div>
                        ))}
                        {filteredStudents.length === 0 && <div className="p-8 text-center opacity-50">No students in this class.</div>}
                    </div>
                </div>
            );
        };

        const ReportView = ({ classes, students, attendance }) => {
             const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
             const [selectedClass, setSelectedClass] = useState(classes[0]?.id || '');
             const reportData = useMemo(() => {
                const relevantStudents = students.filter(s => s.classId == selectedClass);
                return relevantStudents.map(student => {
                    let absenses = 0;
                    attendance.forEach(entry => { if(entry.date.startsWith(selectedMonth) && entry.records[student.id] === 'A') absenses++; });
                    return { ...student, absenses, statusColor: absenses > 2 ? 'bg-red-100 text-red-800' : absenses >= 1 ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800' };
                });
            }, [students, attendance, selectedMonth, selectedClass]);

            const handleExport = () => {
                const ws = XLSX.utils.json_to_sheet(reportData.map(s => ({ Name: s.name, ID: s.generatedId, Absenses: s.absenses })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                XLSX.writeFile(wb, `Attendance_${selectedMonth}.xlsx`);
            };

            return (
                <div className="space-y-6">
                    <div className="flex gap-4 bg-white p-4 rounded-xl shadow-sm no-print items-end">
                        <div><label className="text-xs font-bold opacity-50">Month</label><input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="border p-2 rounded block" /></div>
                        <div><label className="text-xs font-bold opacity-50">Class</label><select value={selectedClass} onChange={e => setSelectedClass(e.target.value)} className="border p-2 rounded block">{classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                        <button onClick={handleExport} className="ml-auto bg-gray-800 text-white px-4 py-2 rounded flex gap-2"><Icon name="microsoft-excel-logo" /> Export</button>
                        <button onClick={() => window.print()} className="bg-indigo-600 text-white px-4 py-2 rounded flex gap-2"><Icon name="printer" /> Print</button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden print-only">
                         <div className="hidden print-only p-4 text-center font-bold text-xl">Monthly Attendance: {selectedMonth}</div>
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b"><tr><th className="p-4">Name</th><th className="p-4 text-center">Absences</th><th className="p-4 text-center">Status</th></tr></thead>
                            <tbody>
                                {reportData.map(s => (
                                    <tr key={s.id} className="border-b last:border-0">
                                        <td className="p-4"><div>{s.name}</div><div className="text-xs opacity-50">{s.generatedId}</div></td>
                                        <td className="p-4 text-center font-bold">{s.absenses}</td>
                                        <td className="p-4 text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${s.statusColor}`}>{s.absenses > 2 ? 'CRITICAL' : s.absenses > 0 ? 'WARNING' : 'GOOD'}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ClassManager = ({ classes, setClasses, showToast }) => {
            const [name, setName] = useState('');
            return (
                <div className="max-w-xl mx-auto bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 className="font-bold text-lg mb-4">Manage Classes</h3>
                    <div className="flex gap-2 mb-6">
                        <input value={name} onChange={e => setName(e.target.value)} className="flex-1 border p-2 rounded outline-none" placeholder="New Class Name" />
                        <button onClick={() => { if(name) { setClasses([...classes, { id: Date.now(), name }]); setName(''); showToast('Class added'); } }} className="bg-indigo-600 text-white px-4 rounded">Add</button>
                    </div>
                    <ul className="divide-y divide-gray-100">
                        {classes.map(c => (
                            <li key={c.id} className="flex justify-between py-3">
                                <span>{c.name}</span>
                                <button onClick={() => { if(confirm('Delete?')) setClasses(classes.filter(cl => cl.id !== c.id)); }} className="text-red-500"><Icon name="trash" /></button>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        };

        const ExamManager = ({ user, classes, students, exams, setExams, showToast, onTriggerAI }) => {
            const [selectedClass, setSelectedClass] = useState(classes[0]?.id || '');
            const subjects = ['Windows', 'Word', 'Excel', 'Access', 'PowerPoint'];
            const [coachSubject, setCoachSubject] = useState(subjects[0]);
            
            const filteredStudents = students.filter(s => s.classId == selectedClass);

            const handleScoreChange = (studentId, subject, value) => {
                if (user.role === 'teacher') { 
                    const currentScore = exams[studentId]?.[subject];
                    if (currentScore && user.role !== 'admin') {
                        showToast("Only Admins can edit submitted scores.", 'error');
                        return;
                    }
                }
                setExams(prev => ({
                    ...prev,
                    [studentId]: { ...prev[studentId], [subject]: value }
                }));
            };

            const toggleCertified = (studentId) => {
                setExams(prev => ({
                    ...prev,
                    [studentId]: { ...prev[studentId], certified: !prev[studentId]?.certified }
                }));
            };

            const handleAICoach = () => {
                const prompt = `Generate 3 beginner-friendly multiple-choice practice questions for ${coachSubject}. 
                Format: Question? [A) opt, B) opt, C) opt] - Correct: X. 
                Make it suitable for students learning computer skills.`;
                onTriggerAI(`${coachSubject} Practice Quiz`, prompt);
            };

            const exportExams = () => {
                const data = filteredStudents.map(s => {
                    const scores = exams[s.id] || {};
                    return {
                        ID: s.generatedId,
                        Name: s.name,
                        ...subjects.reduce((acc, sub) => ({...acc, [sub]: scores[sub] || '-'}), {}),
                        Certified: scores.certified ? 'YES' : 'NO'
                    };
                });
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Exam Scores");
                XLSX.writeFile(wb, "Exam_Scores.xlsx");
            };

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg flex flex-col md:flex-row items-center justify-between gap-4 no-print">
                        <div>
                            <h3 className="text-lg font-bold flex items-center gap-2"><Icon name="brain" /> AI Exam Coach</h3>
                            <p className="text-indigo-100 text-sm opacity-90">Ku samee imtixaan tijaabo ardaydaada hadda.</p>
                        </div>
                        <div className="flex gap-2">
                            <select value={coachSubject} onChange={(e) => setCoachSubject(e.target.value)} className="text-gray-800 rounded-lg p-2 text-sm outline-none">
                                {subjects.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <button onClick={handleAICoach} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2 backdrop-blur-sm border border-white/30">
                                <Icon name="sparkle" className="text-yellow-300" /> Generate Quiz
                            </button>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-4 items-end no-print">
                        <div>
                            <label className="block text-xs font-bold opacity-50 uppercase mb-1">Select Class</label>
                            <select value={selectedClass} onChange={e => setSelectedClass(e.target.value)} className="border p-2 rounded-lg min-w-[200px]">
                                {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                        </div>
                        <div className="flex-1"></div>
                        <button onClick={exportExams} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"><Icon name="microsoft-excel-logo" /> Export</button>
                        <button onClick={() => window.print()} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2"><Icon name="printer" /> Print</button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto print-only">
                        <div className="hidden print-only p-4 text-center font-bold text-2xl">Exam Report Sheet</div>
                        <table className="w-full text-left min-w-[1200px]">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="p-3 text-sm font-semibold opacity-60 w-40 sticky left-0 bg-white z-10">Student</th>
                                    {subjects.map(sub => <th key={sub} className="p-3 text-sm font-semibold opacity-60 text-center whitespace-nowrap">{sub}</th>)}
                                    <th className="p-3 text-sm font-semibold opacity-60 text-center">Certified</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {filteredStudents.map(s => {
                                    const sExams = exams[s.id] || {};
                                    return (
                                        <tr key={s.id} className="hover:bg-gray-50">
                                            <td className="p-3 sticky left-0 bg-white hover:bg-gray-50 z-10 border-r">
                                                <div className="font-medium text-gray-800">{s.name}</div>
                                                <div className="text-xs opacity-50">{s.generatedId}</div>
                                            </td>
                                            {subjects.map(sub => (
                                                <td key={sub} className="p-3 text-center">
                                                    <input 
                                                        type="number" 
                                                        className="w-12 text-center border rounded p-1 focus:ring-2 focus:ring-indigo-500 outline-none no-print text-sm" 
                                                        value={sExams[sub] || ''}
                                                        onChange={(e) => handleScoreChange(s.id, sub, e.target.value)}
                                                        readOnly={user.role !== 'admin' && sExams[sub]} 
                                                    />
                                                    <span className="hidden print-only">{sExams[sub] || '-'}</span>
                                                </td>
                                            ))}
                                            <td className="p-3 text-center">
                                                <button 
                                                    onClick={() => toggleCertified(s.id)}
                                                    className={`p-2 rounded-full ${sExams.certified ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} hover:opacity-80 transition`}
                                                >
                                                    <Icon name={sExams.certified ? 'check' : 'x'} className="text-lg font-bold" />
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const UserManager = ({ users, setUsers, teachersList, setTeachersList, showToast }) => {
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'teacher', name: '' });
            const [newTeacherName, setNewTeacherName] = useState('');

            const addUser = (e) => {
                e.preventDefault();
                if(!newUser.username || !newUser.password) return;
                setUsers([...users, { ...newUser, id: Date.now() }]);
                setNewUser({ username: '', password: '', role: 'teacher', name: '' });
                showToast('User added successfully');
            };

            const addTeacherToList = () => {
                if(newTeacherName && !teachersList.includes(newTeacherName)) {
                    setTeachersList([...teachersList, newTeacherName]);
                    setNewTeacherName('');
                    showToast('Teacher added to list');
                }
            };

            const deleteUser = (id) => {
                if(confirm('Delete user access?')) setUsers(users.filter(u => u.id !== id));
            };

            return (
                <div className="grid md:grid-cols-2 gap-6">
                    {/* User Accounts */}
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 className="font-bold text-lg mb-4">System Users (Login)</h3>
                            <form onSubmit={addUser} className="space-y-3 mb-4">
                                <input className="w-full border p-2 rounded" placeholder="Display Name" value={newUser.name} onChange={e=>setNewUser({...newUser, name: e.target.value})} />
                                <input className="w-full border p-2 rounded" placeholder="Username" value={newUser.username} onChange={e=>setNewUser({...newUser, username: e.target.value})} />
                                <input className="w-full border p-2 rounded" placeholder="Password" value={newUser.password} onChange={e=>setNewUser({...newUser, password: e.target.value})} />
                                <select className="w-full border p-2 rounded" value={newUser.role} onChange={e=>setNewUser({...newUser, role: e.target.value})}>
                                    <option value="teacher">Teacher</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <button className="w-full bg-indigo-600 text-white p-2 rounded font-bold hover:bg-indigo-700">Add User</button>
                            </form>
                            <ul className="space-y-2">
                                {users.map(u => (
                                    <li key={u.id} className="flex justify-between items-center p-3 bg-gray-50 rounded border">
                                        <div>
                                            <p className="font-bold text-sm">{u.username} <span className="text-xs opacity-60">({u.role})</span></p>
                                            <p className="text-xs opacity-50">Pass: {u.password}</p>
                                        </div>
                                        <button onClick={() => deleteUser(u.id)} className="text-red-500"><Icon name="trash" /></button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>

                    {/* Teacher Dropdown Options */}
                    <div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                            <h3 className="font-bold text-lg mb-4">Teacher List Options</h3>
                            <div className="flex gap-2 mb-4">
                                <input className="flex-1 border p-2 rounded" placeholder="Teacher Name" value={newTeacherName} onChange={e=>setNewTeacherName(e.target.value)} />
                                <button onClick={addTeacherToList} className="bg-green-600 text-white px-4 rounded hover:bg-green-700"><Icon name="plus" /></button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {teachersList.map(t => (
                                    <span key={t} className="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm border border-indigo-100 flex items-center gap-2 dark:bg-gray-700 dark:text-indigo-300 dark:border-gray-600">
                                        {t} <Icon name="x" className="cursor-pointer hover:text-red-500" onClick={() => setTeachersList(teachersList.filter(i => i !== t))} />
                                    </span>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
